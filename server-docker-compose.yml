services:
  postgres:
    image: postgres:16-alpine
    container_name: sma-postgres
    restart: unless-stopped

    env_file:
      - .env

    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

    ports:
      - "5432:5432"

    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
      -c logging_collector=on
      -c log_destination=stderr
      -c log_directory=/var/log/postgresql
      -c log_filename=postgresql.log
      -c log_line_prefix='%t [%p] %u@%d %r '
      -c log_connections=on
      -c log_disconnections=on
      -c log_hostname=on

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /var/docker/sma/logs/postgres:/var/log/postgresql
      - ./postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./init:/docker-entrypoint-initdb.d

    networks:
      - sma-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

    security_opt:
      - no-new-privileges:true

  sma-core-service:
    image: anhtu2808/sma-core-service:latest
    container_name: sma-core-service
    restart: unless-stopped

    env_file:
      - .env
    
    ports:
      - "8080:8080"

    volumes:
      - /var/docker/sma/logs/core-service:/app/logs

    networks:
      - sma-network

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    security_opt:
      - no-new-privileges:true

  sma-ai-service:
    image: anhtu2808/sma-ai-service:latest
    container_name: sma-ai-service
    restart: unless-stopped

    env_file:
      - .env

    ports:
      - "8000:8000"

    volumes:
      - /var/docker/sma/logs/ai-service:/app/logs

    networks:
      - sma-network

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=3)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    security_opt:
      - no-new-privileges:true

volumes:
  postgres_data:

networks:
  sma-network:
    driver: bridge
